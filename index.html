<script type="text/javascript">
function bytesIndexOf(arr, sep){
    if(sep.length > arr.length){
        return -1
    }
    var end = arr.length - sep.length
    var ok = true
    for(var i=0; i<end; i++){
        ok = true   
        for(var j=0; j<sep.length; j++){
            if(arr[i+j] != sep[j]){
                ok = false
                break
            }
        }
        if(ok){
            return i
        }
    }
    return -1
}

function getPhotoOrientation(bbb)  {
	var orien = -1
    var bb = bbb.slice(0, 2**16)
	if(bb[0] != 0xff || bb[1] != 0xd8 || bb[3] == 0xe0 ){
		return -1
	}

	if( !(bb[12] == 0x49 || bb[12] == 0x4d) ){
		return -1
	}

	var idx = 0
    var oriIdx = -1
	//! byte align 확인
	if(bb[15] == 0x2a ){
		idx = bytesIndexOf(bb, [0x01, 0x12, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01])
		orien = bb[idx+9]
        oriIdx = idx+9
	} else if( bb[14] == 0x2a ){
		//! 12 01 03 00 01 00 00 00 01 00 00 00     // Orientation
		idx = bytesIndexOf(bb, [0x12, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00])
		orien = bb[idx+8]
        oriIdx = idx+8

	} else {
		return -1
	}

	if(idx < 0 || idx > 0xffff || orien < 1 || orien > 8){
		return -1
	}

    // bbb[oriIdx] = 0x01

    // bbb[0] = 0x00
	return orien
}

async function onChangeInputFile(self){
    if(self.files.length < 1){
        return
    }

    var file = self.files[0]

    const arrayBuffer = await file.arrayBuffer();   //! 이 부분 사파리 브라우져에서 안될 수있다.
    var array = new Uint8Array(arrayBuffer);

    var orien = getPhotoOrientation(array)

    getById('eOrien').innerText = `${orien}`
}

function getById(id){
    return document.getElementById(id)
}
function log(...args){
    console.log(...args)
}
window.onload = ()=>{

}
</script>


<!---------------------------------------------->
<!---------------------------------------------->
<!---------------------------------------------->
<div style="font-size:25px;">

    <div style="display:inline-block;">
        Orientation : 
    </div>
    <div id="eOrien" 
        style="display:inline-block;">
        0
    </div>
</div>
<div style="margin-top:15px;"></div>
<div>
    <div style="display:inline-block;
            border:1px solid #437dbd; 
            border-radius:5px;
            padding:5px;">
        <input type="file"
            onchange="onChangeInputFile(this)"
            />
    </div>
</div>







<!---------------------------------------------->
<!---------------------------------------------->
<!---------------------------------------------->
